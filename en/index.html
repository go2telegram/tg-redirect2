<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="referrer" content="origin-when-cross-origin" />
  <title>Opening Telegram…</title>
  <meta name="description" content="Join the Telegram channel. Open in the app, use the browser, or install Telegram." />
  <meta name="theme-color" content="#0f1115" />
  <meta property="og:title" content="Opening Telegram…" />
  <meta property="og:description" content="Click a button below to join via Telegram." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://dummyimage.com/1200x630/0f1115/ffffff&text=Telegram+Redirect" />
  <style>
    :root{
      --bg:#0f1115;--card:#141821;--text:#e6e8ec;--muted:#a3a7b0;--btn:#1b88ff;--btn2:#232a36;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text); font-family:sans-serif;
      display:flex; align-items:center; justify-content:center; height:100vh; padding:24px;
    }
    .card{max-width:640px; background:var(--card); border-radius:20px; padding:32px; text-align:center}
    h1{margin:0 0 12px;font-size:28px}
    p{margin:0 0 24px;color:var(--muted)}
    .grid{display:flex; gap:12px; flex-wrap:wrap; justify-content:center}
    .btn{
      border:0; border-radius:12px; padding:14px 18px; font-size:16px; cursor:pointer;
      background:var(--btn2); color:var(--text);
    }
    .btn.primary{background:var(--btn); color:#fff; font-weight:600}
    .toast{position:fixed; left:50%; bottom:26px; transform:translateX(-50%); background:#1b2332; color:#fff; padding:10px 14px; border-radius:10px; font-size:14px; opacity:0; pointer-events:none; transition:opacity .25s}
    .toast.show{opacity:1}
    .note{margin-top:16px; color:#8891a1; font-size:14px}
  </style>

  <script>
    // Redirect settings
    const TG_DEEPLINK_DEFAULT = "tg://join?invite=iV_wv-sPlZhhNjFi";
    const TG_WEB_FALLBACK_DEFAULT = "https://t.me/+iV_wv-sPlZhhNjFi";
    const YA_COUNTER_ID = 104141664;
  </script>
</head>
<body>
  <div class="card">
    <h1>Opening Telegram…</h1>
    <p>Click a button below to join via Telegram. If the app isn’t installed, use the browser or download the app.</p>
    <div class="grid">
      <button id="btn-open-app" class="btn primary">Open in Telegram</button>
      <button id="btn-open-web" class="btn">Open in Browser</button>
      <button id="btn-download" class="btn">Get Telegram</button>
      <button id="btn-copy" class="btn">Copy Link</button>
    </div>
    <div class="note" id="platform-note"></div>
  </div>
  <div id="toast" class="toast">Link copied</div>

  <script>
    const UA = (navigator.userAgent || '') + ' ' + (navigator.vendor || '');
    const isAndroid = /android/i.test(UA);
    const isIOS = /iPhone|iPad|iPod/i.test(UA) || ((/Mac|Macintosh/i.test(UA)) && (navigator.maxTouchPoints||0) > 1);
    const isInApp  = /(Instagram|FBAN|FBAV|TikTok|TTWebView|BytedanceWebview|Aweme|musical\.ly|VK(Client|Share)|OKApp|YaApp_Android|YaApp_iOS)/i.test(UA);

    const note = document.getElementById('platform-note');
    if (note) {
      if (isInApp) {
        note.textContent = 'Looks like you opened the link inside another app. Use “Open in Browser” in the ⋯ menu.';
      } else if (isIOS) {
        note.textContent = 'Detected: iOS';
      } else if (isAndroid) {
        note.textContent = 'Detected: Android';
      } else {
        note.textContent = 'Detected: Desktop';
      }
    }

    const storeIOS = `https://apps.apple.com/app/telegram-messenger/id686449807`;
    const storeAndroid = `https://play.google.com/store/apps/details?id=org.telegram.messenger`;
    const storeDesktop = `https://desktop.telegram.org/`;

    const urlParams = new URLSearchParams(location.search);

    function applyReferrerAutodetect(params) {
      let utmSource = params.get('utm_source');
      let utmMedium = params.get('utm_medium');

      if (utmSource) return params;

      const ref = document.referrer || '';
      if (!ref) return params;

      let host = '';
      let path = '';
      try {
        const refUrl = new URL(ref);
        host = (refUrl.hostname || '').toLowerCase();
        path = (refUrl.pathname || '').toLowerCase();
      } catch (_) {
        host = ref.toLowerCase();
      }

      const setSource = (source, mediumIfEmpty) => {
        if (!utmSource) {
          params.set('utm_source', source);
          utmSource = source;
        }
        if (!utmMedium && mediumIfEmpty) {
          params.set('utm_medium', mediumIfEmpty);
          utmMedium = mediumIfEmpty;
        }
      };

      if (host.includes('tiktok.com')) {
        setSource('tiktok', 'video');
      } else if (host.includes('instagram.com')) {
        setSource('instagram', 'reels');
      } else if (host.includes('youtube.com') || host.includes('youtu.be')) {
        const isShort = path.includes('/shorts');
        setSource('youtube', isShort ? 'shorts' : 'video');
      } else if (host === 't.me' || host.endsWith('.t.me') || host.includes('telegram.org')) {
        setSource('telegram', 'social');
      }

      return params;
    }

    applyReferrerAutodetect(urlParams);
    const preservedEntries = Array.from(urlParams.entries()).filter(([key]) => {
      const lower = key.toLowerCase();
      return lower.startsWith('utm_') || ['s','src','ref','gclid','fbclid','ttclid','yclid'].includes(lower);
    });

    function withUTM(targetUrl) {
      if (!preservedEntries.length) return targetUrl;
      try {
        const parsed = new URL(targetUrl);
        preservedEntries.forEach(([key, value]) => {
          if (value) parsed.searchParams.set(key, value);
        });
        return parsed.toString();
      } catch (_) {
        try {
          const hashIndex = targetUrl.indexOf('#');
          const hash = hashIndex >= 0 ? targetUrl.slice(hashIndex) : '';
          const base = hashIndex >= 0 ? targetUrl.slice(0, hashIndex) : targetUrl;
          const questionIndex = base.indexOf('?');
          const query = questionIndex >= 0 ? base.slice(questionIndex + 1) : '';
          const prefix = questionIndex >= 0 ? base.slice(0, questionIndex) : base;
          const params = new URLSearchParams(query);
          preservedEntries.forEach(([key, value]) => {
            if (value) params.set(key, value);
          });
          const nextQuery = params.toString();
          return prefix + (nextQuery ? `?${nextQuery}` : '') + hash;
        } catch (_) {
          return targetUrl;
        }
      }
    }

    const tgOverride = urlParams.get('tg');
    const fallbackOverride = urlParams.get('fallback');
    const TG_DEEPLINK = withUTM(tgOverride || TG_DEEPLINK_DEFAULT);
    const TG_WEB_FALLBACK = withUTM(fallbackOverride || TG_WEB_FALLBACK_DEFAULT);

    try {
      const qs = new URLSearchParams(location.search);
      const url = new URL(location.href);
      let changed = false;
      ["utm_source","utm_medium","utm_campaign","utm_content"].forEach(k=>{
        if(qs.get(k)) {
          if (url.searchParams.get(k) !== qs.get(k)) {
            url.searchParams.set(k, qs.get(k));
            changed = true;
          }
        }
      });
      if (changed) history.replaceState(null, "", url.toString());
    } catch(_) {}

    const elOpen  = document.getElementById('btn-open-app');
    const elWeb   = document.getElementById('btn-open-web');
    const elStore = document.getElementById('btn-download');
    const elCopy  = document.getElementById('btn-copy');
    const toast   = document.getElementById('toast');

    function goal(name){ try{ ym(YA_COUNTER_ID,'reachGoal',name); } catch(_){} }

    function sendMetrikaHit() {
      try {
        ym(YA_COUNTER_ID, 'hit', location.href);
        ym(YA_COUNTER_ID, 'reachGoal', 'tg_redirect_open');
      } catch (_) {}
    }

    function showToast(msg){
      if (!toast) return;
      toast.textContent=msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'),1600);
    }

    function openTelegramChain() {
      sendMetrikaHit();
      setTimeout(() => {
        window.location.href = TG_DEEPLINK;
      }, 350);
      setTimeout(() => {
        window.location.href = TG_WEB_FALLBACK;
      }, 1500);
    }

    document.addEventListener('DOMContentLoaded', function () {
      openTelegramChain();
    });

    elOpen.addEventListener('click', (e)=>{
      e.preventDefault();
      goal('open_app');
      openTelegramChain();
    });

    elWeb.addEventListener('click', (e)=>{
      e.preventDefault();
      goal('open_web');
      window.location.href = TG_WEB_FALLBACK;
    });

    elStore.addEventListener('click', (e)=>{
      e.preventDefault();
      let target = storeDesktop;
      if (isIOS) target = storeIOS;
      else if (isAndroid) target = storeAndroid;
      window.location.href = withUTM(target);
      goal('open_store');
    });

    elCopy.addEventListener('click', async (e)=>{
      e.preventDefault();
      try {
        await navigator.clipboard.writeText(TG_WEB_FALLBACK);
        showToast('Link copied');
        goal('copy_link');
      } catch (_) {
        alert('Copy the link:\n' + TG_WEB_FALLBACK);
      }
    });
  </script>

  <!-- Yandex.Metrika -->
  <script type="text/javascript">
    (function(m,e,t,r,i,k,a){
      m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
      m[i].l=1*new Date();
      k=e.createElement(t),a=e.getElementsByTagName(t)[0];
      k.async=1;k.src=r;a.parentNode.insertBefore(k,a)
    })(window, document, "script", `https://mc.yandex.ru/metrika/tag.js?id=${YA_COUNTER_ID}`, "ym");

    ym(YA_COUNTER_ID,"init",{clickmap:true, trackLinks:true, accurateTrackBounce:true});
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/104141664" style="position:absolute; left:-9999px;" alt=""/></div></noscript>
</body>
</html>
