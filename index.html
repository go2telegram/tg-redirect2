<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Opening Telegram…</title>
  <meta name="description" content="Join the Telegram channel. Open in the app, use the browser, or install Telegram." />
  <meta name="theme-color" content="#0f1115" />
  <meta property="og:title" content="Opening Telegram…" />
  <meta property="og:description" content="Click a button below to join via Telegram." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://dummyimage.com/1200x630/0f1115/ffffff&text=Telegram+Redirect" />
  <style>
    :root {
      --bg: #0f1115;
      --gradient: radial-gradient(1200px 800px at 70% -10%, #1a2030 0%, rgba(15, 17, 21, 0) 60%);
      --card: #141821;
      --text: #e6e8ec;
      --muted: #a3a7b0;
      --btn: #1b88ff;
      --btn-hover: #3a9bff;
      --btn2: #232a36;
      --btn2-hover: #2d3646;
      --radius: 16px;
      --transition: 0.2s ease;
    }

    * { box-sizing: border-box; }

    html, body { height: 100%; }

    body {
      margin: 0;
      background: var(--bg);
      background-image: var(--gradient);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Helvetica Neue", "Noto Sans", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .card {
      width: 100%;
      max-width: 940px;
      background: var(--card);
      border-radius: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      padding: clamp(28px, 4vw, 40px);
    }

    h1 {
      margin: 0 0 12px;
      font-size: clamp(28px, 5vw, 40px);
      letter-spacing: 0.2px;
    }

    p {
      margin: 0 0 24px;
      color: var(--muted);
      font-size: clamp(16px, 2.6vw, 18px);
      line-height: 1.5;
    }

    .grid {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .btn {
      appearance: none;
      border: 0;
      border-radius: var(--radius);
      padding: 16px 20px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      background: var(--btn2);
      color: var(--text);
      transition: transform 0.06s ease, opacity var(--transition), background var(--transition);
    }

    .btn.primary {
      background: var(--btn);
      color: #fff;
      font-weight: 600;
    }

    .btn:hover {
      transform: translateY(-1px);
      background: var(--btn2-hover);
    }

    .btn.primary:hover {
      background: var(--btn-hover);
    }

    .btn:active {
      transform: translateY(0);
      opacity: 0.88;
    }

    .btn:focus-visible {
      outline: 2px solid rgba(27, 136, 255, 0.55);
      outline-offset: 2px;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 26px;
      transform: translateX(-50%);
      background: rgba(27, 35, 50, 0.92);
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 14px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }

    .toast.show {
      opacity: 1;
    }

    .note {
      margin-top: 18px;
      color: #8891a1;
      font-size: 14px;
    }

    @media (max-width: 520px) {
      .grid {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="card" role="region" aria-label="Telegram redirect">
    <h1>Opening Telegram…</h1>
    <p>Click a button below to join via Telegram. If the app isn’t installed, use the browser or download the app.</p>
    <div class="grid">
      <button id="btn-open-app" class="btn primary" type="button">Open in Telegram</button>
      <button id="btn-open-web" class="btn" type="button">Open in Browser</button>
      <button id="btn-download" class="btn" type="button">Get Telegram</button>
      <button id="btn-copy" class="btn" type="button">Copy Link</button>
    </div>
    <div class="note" id="platform-note" aria-live="polite"></div>
  </div>
  <div id="toast" class="toast" role="status" aria-live="polite">Link copied</div>

  <script>
    // ===== CONFIG =====
    const TARGET_URL = "https://t.me/+iV_wv-sPlZhhNjFi";       // final URL
    const TG_INVITE_TOKEN = "iV_wv-sPlZhhNjFi";                 // invite token after +
    const YA_COUNTER_ID = 99999999;                             // <-- REPLACE with real Yandex.Metrika ID

    // ===== UTM / Ref capture =====
    const params = new URLSearchParams(window.location.search);
    const hasTrackedParams = [...params.keys()].some(key => key.startsWith("utm_")) || params.has("ref");
    if (hasTrackedParams) {
      sessionStorage.setItem("redirect_ref", window.location.search.replace(/^\?/, ""));
    }
    const storedRef = sessionStorage.getItem("redirect_ref") || "";

    // ===== Platform detection =====
    const ua = navigator.userAgent || "";
    const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
    const isAndroid = /Android/i.test(ua);
    const isDesktop = !isIOS && !isAndroid;

    // ===== Metrics helper =====
    const goalQueue = [];
    let flushHandle = null;
    function flushGoals() {
      if (typeof ym === "function") {
        while (goalQueue.length) {
          const goalName = goalQueue.shift();
          try {
            ym(YA_COUNTER_ID, "reachGoal", goalName);
          } catch (err) {
            // If ym throws, stop flushing to avoid infinite loop
            break;
          }
        }
      } else if (!flushHandle) {
        flushHandle = setTimeout(() => {
          flushHandle = null;
          flushGoals();
        }, 600);
      }
    }

    function goal(name) {
      goalQueue.push(name);
      flushGoals();
    }

    // ===== UI helpers =====
    const toastEl = document.getElementById("toast");
    let toastTimer = null;
    function showToast(message) {
      toastEl.textContent = message;
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toastEl.classList.remove("show"), 1800);
    }

    function appendRefParam(baseUrl) {
      if (!storedRef) return baseUrl;
      try {
        const url = new URL(baseUrl);
        url.searchParams.set("ref", storedRef);
        return url.toString();
      } catch (err) {
        const joiner = baseUrl.includes("?") ? "&" : "?";
        return `${baseUrl}${joiner}ref=${encodeURIComponent(storedRef)}`;
      }
    }

    function openTelegramApp() {
      const appUrl = `tg://join?invite=${TG_INVITE_TOKEN}`;
      goal("open_app");

      if (isIOS || isAndroid) {
        const fallbackDelay = isIOS ? 1600 : 1200;
        const fallbackId = setTimeout(() => {
          if (!document.hidden) {
            window.location.href = TARGET_URL;
          }
        }, fallbackDelay);

        const visibilityHandler = () => {
          if (document.hidden) {
            clearTimeout(fallbackId);
            document.removeEventListener("visibilitychange", visibilityHandler);
          }
        };

        document.addEventListener("visibilitychange", visibilityHandler);

        setTimeout(() => {
          clearTimeout(fallbackId);
          document.removeEventListener("visibilitychange", visibilityHandler);
        }, 4000);
      }

      window.location.href = appUrl;
    }

    function openTelegramWeb() {
      goal("open_web");
      window.location.href = TARGET_URL;
    }

    function downloadTelegram() {
      goal("download");
      if (isIOS) {
        window.location.href = appendRefParam("https://apps.apple.com/app/telegram-messenger/id686449807");
      } else if (isAndroid) {
        window.location.href = appendRefParam("https://play.google.com/store/apps/details?id=org.telegram.messenger");
      } else {
        window.location.href = appendRefParam("https://desktop.telegram.org/");
      }
    }

    function copyLink() {
      const text = TARGET_URL;
      const onSuccess = () => {
        showToast("Link copied");
        goal("copy_link");
      };
      const onFailure = () => {
        showToast("Copy failed");
      };

      if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
        navigator.clipboard.writeText(text).then(onSuccess).catch(onFailure);
      } else {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.setAttribute("readonly", "");
        textarea.style.position = "absolute";
        textarea.style.left = "-9999px";
        document.body.appendChild(textarea);
        textarea.select();
        try {
          const successful = document.execCommand("copy");
          if (successful) {
            onSuccess();
          } else {
            onFailure();
          }
        } catch (err) {
          onFailure();
        }
        document.body.removeChild(textarea);
      }
    }

    // ===== Bindings =====
    document.getElementById("btn-open-app").addEventListener("click", openTelegramApp);
    document.getElementById("btn-open-web").addEventListener("click", openTelegramWeb);
    document.getElementById("btn-download").addEventListener("click", downloadTelegram);
    document.getElementById("btn-copy").addEventListener("click", copyLink);

    // ===== Platform note =====
    const note = document.getElementById("platform-note");
    if (note) {
      note.textContent = `Detected: ${isIOS ? "iOS" : isAndroid ? "Android" : "Desktop"}`;
    }
    goal("auto_detect_os");
    flushGoals();
  </script>

  <!-- ===== Yandex.Metrika ===== -->
  <script type="text/javascript">
    (function(m,e,t,r,i,k,a){
      m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
      m[i].l=1*new Date();
      k=e.createElement(t),a=e.getElementsByTagName(t)[0];
      k.async=1;k.src=r;a.parentNode.insertBefore(k,a);
    })(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(YA_COUNTER_ID, "init", {
      clickmap: true,
      trackLinks: true,
      accurateTrackBounce: true,
      defer: true
    });
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/99999999" style="position:absolute; left:-9999px;" alt=""/></div></noscript>
  <!-- ========================== -->
</body>
</html>
